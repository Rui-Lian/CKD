---
title: "Getting data"
author: "Lian Rui"
date: "9/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      warning = F,
                      cache = T)
```

```{r Packages.}
library(tidyverse)
library(lubridate)
library(readxl)
```

```{r Helper functions. }
# Read all excel sheets. 
read_excel_allsheets <- function(filename, 
                                 tibble = FALSE) {
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}
## Source: https://stackoverflow.com/questions/12945687/read-all-worksheets-in-an-excel-workbook-into-an-r-list-with-data-frames
```

```{r year name}
year <- paste0("year", 2012:2020)
```

```{r}
# Read 9 excel sheets and return 9 data frames.  
my_dat <- read_excel_allsheets(filename = 'data/raw.xlsx')

# For each data frame
total <- data.frame()

for (i in 1:length(my_dat)) {
    
    # Label year for each data frame
    my_dat[[i]]$year <- year[i]
    
    # Fill each row with HIS id. 
    # A vector
    l <- vector()
    # Loop to fill HIS. 
    for (j in 1:nrow(my_dat[[i]])) {
        if(!is.na(my_dat[[i]]$`患者His号（完整10位数）`[j])){
            l[j] = my_dat[[i]]$`患者His号（完整10位数）`[j]
            }else{
                l[j] = l[j-1]
            }
    }
    
    # New HIS id and remove old HIS
    my_dat[[i]]$HIS_new<-l

    # pt info table
    # Col 2-9 as pt info. 
    # Col ncol(df) as row-filled HIS id. 
    pt_info <- my_dat[[i]][, c(2:9, ncol(my_dat[[i]]))]
    # Remove rows of all NAs. 
    pt_info <- pt_info %>%
        filter_all(any_vars(!is.na(.)))
    
    #Column rename of pt info
    colnames(pt_info) <- c("Gender", "Age", "HIS",
                           "Doctor", "ICD", "Dx",
                           "In-Patient", "Follow_up", "HIS_new")
    
    # Cols from col 10 as data
    # Data labeled with HIS id.
    # Col 4: HIS ID
    # Col 10 to end: data and date
    pt_data <- my_dat[[i]][, c(10:ncol(my_dat[[i]]))]
    # HIS_new as first column
    pt_data <- pt_data %>%
        select(HIS_new, everything())
    
    
    # Rearrange each pt_data to long format
    dat <- data.frame()
    for(k in 1:((ncol(pt_data)-1)/2)) {
        if(2*k + 1 <= ncol(pt_data)) {
            tmp <- pt_data[, c(1, (2*k):(2*k + 1), ncol(pt_data))]
            tmp$name <- colnames(tmp)[2]
            colnames(tmp)[2:3] <- c("data", "date")
            dat <- rbind(dat, tmp)
        }
    }
    # In each year
    # Join dat (long format pts data)
    # With pt_info
    dat <- dat %>%
        right_join(pt_info, by = "HIS_new")
    
    # Combine data of 9 years
    total <- rbind(total, dat)
}
```

```{r data cleaning}
# Date format
total$date <- ymd(total$date)
# Remove old HIS id. 
total <- total %>%
    select(-HIS)
# Remove NAs of pt_info
# This is redudant
total <- total %>%
    filter(!is.na(Gender) & 
               !is.na(Age) &
               !is.na(Doctor))
# Remove doctor, Follow_up columns
# All entries in Follow_up is high
total <- total %>%
    select(-Doctor, -Follow_up)

total <- total %>%
    filter(!is.na(data))

total <- distinct(total)
```


## Appendix

String as object name
```{r}
value <- 1:5

for (i in 1:2) {
    x <- paste("varname",i, sep="")
    eval(call("<-", as.name(x), value))
}
varname2
```

```{r}
read_excel_allsheets <- function(filename, tibble = FALSE) {
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}

my_dat <- read_excel_allsheets(filename = 'data/raw.xlsx')

View(my_dat[[1]])
```

