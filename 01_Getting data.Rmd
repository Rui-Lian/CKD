---
title: "Getting data"
author: "Lian Rui"
date: "9/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      warning = F,
                      cache = T)
```

```{r Packages.}
library(tidyverse)
library(lubridate)
library(readxl)
```

```{r Helper functions. }
# Read all excel sheets. 
source("excel_all_sheets.R")
```

```{r Chinese character setup}
theme <- theme_get()
#using the Chinese fonts you have, check it with font book.  
theme$text$family <- "STFangsong"
theme_set(theme)
```

```{r year name}
year <- paste0("year", 2012:2020)
```

```{r include=FALSE}
# Read 9 excel sheets and return 9 data frames.  
my_dat <- read_excel_allsheets(filename = 'data/raw.xlsx')

# For each data frame
total <- data.frame()

for (i in 1:length(my_dat)) {
    
    # Label year for each data frame
    my_dat[[i]]$year <- year[i]
    
    # Fill each row with HIS id. 
    # A vector
    l <- vector()
    # Loop to fill HIS. 
    for (j in 1:nrow(my_dat[[i]])) {
        if(!is.na(my_dat[[i]]$`患者His号（完整10位数）`[j])){
            l[j] = my_dat[[i]]$`患者His号（完整10位数）`[j]
            }else{
                l[j] = l[j-1]
            }
    }
    
    # New HIS id and remove old HIS
    my_dat[[i]]$HIS_new<-l

    # pt info table
    # Col 2-9 as pt info. 
    # Col ncol(df) as row-filled HIS id. 
    pt_info <- my_dat[[i]][, c(2:9, ncol(my_dat[[i]]))]
    # Remove rows of all NAs. 
    pt_info <- pt_info %>%
        filter_all(any_vars(!is.na(.)))
    
    #Column rename of pt info
    colnames(pt_info) <- c("Gender", "Age", "HIS",
                           "Doctor", "ICD", "Dx",
                           "In-Patient", "Follow_up", "HIS_new")
    
    # Cols from col 10 as data
    # Data labeled with HIS id.
    # Col 4: HIS ID
    # Col 10 to end: data and date
    pt_data <- my_dat[[i]][, c(10:ncol(my_dat[[i]]))]
    # HIS_new as first column
    pt_data <- pt_data %>%
        select(HIS_new, everything())
    
    
    # Rearrange each pt_data to long format
    dat <- data.frame()
    for(k in 1:((ncol(pt_data)-1)/2)) {
        if(2*k + 1 <= ncol(pt_data)) {
            tmp <- pt_data[, c(1, (2*k):(2*k + 1), ncol(pt_data))]
            tmp$name <- colnames(tmp)[2]
            colnames(tmp)[2:3] <- c("data", "date")
            dat <- rbind(dat, tmp)
        }
    }
    # In each year
    # Join dat (long format pts data)
    # With pt_info
    dat <- dat %>%
        right_join(pt_info, by = "HIS_new")
    
    # Combine data of 9 years
    total <- rbind(total, dat)
}
```

```{r data cleaning}
# Date format
total$date <- ymd(total$date)
# Remove old HIS id. 
total <- total %>%
    select(-HIS)
# Remove NAs of redudant pt_info
total <- total %>%
    filter(!is.na(Gender) & 
               !is.na(Age) &
               !is.na(Doctor))
# Remove 'doctor', 'Follow_up' columns
# All entries in 'Follow_up' is high
total <- total %>%
    select(-Doctor, -Follow_up)

# Drop NAs
total <- total %>%
    filter(!is.na(data))
# Remove repeated entries. 
total <- distinct(total)
```

```{r Consolidate ICD entries. }
icd <- table(total$ICD)

write.csv(icd, "icd.csv")
```


```{r remove BP and weight}
# BP weight data only available in 2020
# Excluded from longitudinal analysis
# Included in 2020 cross-sectional analysis. 
longi_total <- total %>%
    filter(!name %in% "收缩压" &
               !name %in% "舒张压" &
               !name %in% "体重")
```

```{r annual mean by metrics}
# For each HIS id, 
# Calculate the annual mean of each metric
annual_mean <- longi_total %>%
    group_by(HIS_new, year, name) %>%
    summarise(mu = mean(data, na.rm = TRUE))
```

```{r Plot annual mean, fig.width=8, fig.asp=.618}
# For each HIS id, 
# Plot the annual mean of each metric
# Facet by metric. 
ggplot(annual_mean) + 
    geom_line(aes(x = year, y = mu, 
                  colour = name, 
                  group = HIS_new), 
              alpha = .8) + 
    facet_wrap(name~.,scales = "free") 
```
甘油三酯：2020
```{r}
outlier <- total %>%
    filter(HIS_new %in% "0000373621" & 
               name %in% "甘油三酯" & 
               year %in% "year2020")

total[total$HIS_new == "0000373621" & 
               total$name == "甘油三酯" & 
               total$year == "year2020" & 
          total$data == 22.29, ]$data <- median(outlier$data)
```


血清肌酐：2013，2015
```{r}
outlier <- total %>%
    filter((HIS_new %in% "0005316026") & 
               name %in% "血清肌酐" & 
               year %in% "year2013") %>%
    arrange(desc(data))

outlier

total[total$HIS_new == "0005316026" & 
               total$name == "血清肌酐" & 
               total$year == "year2013" & 
          total$data == 25938.0, ]$data <- median(outlier$data)
```

```{r}
outlier <- total %>%
    filter((HIS_new %in% "0000701411") & 
               name %in% "血清肌酐" & 
               year %in% "year2013") %>%
    arrange(desc(data))

outlier

total[total$HIS_new == "0000701411" & 
               total$name == "血清肌酐" & 
               total$year == "year2013" & 
          total$data == 23239.0, ]$data <- median(outlier$data)
```

```{r}
outlier <- total %>%
    filter((HIS_new %in% "0005922995") & 
               name %in% "血清肌酐" & 
               year %in% "year2015") %>%
    arrange(desc(data))

outlier

total[total$HIS_new == "0005922995" & 
               total$name == "血清肌酐" & 
               total$year == "year2015" & 
          total$data == 1997.0, ]$data <- median(outlier$data)
```


```{r remove BP and weight}
# BP weight data only available in 2020
# Excluded from longitudinal analysis
# Included in 2020 cross-sectional analysis. 
longi_total <- total %>%
    filter(!name %in% "收缩压" &
               !name %in% "舒张压" &
               !name %in% "体重")
```

```{r annual mean by metrics}
# For each HIS id, 
# Calculate the annual mean of each metric
annual_mean <- longi_total %>%
    group_by(HIS_new, year, name) %>%
    summarise(mu = mean(data, na.rm = TRUE))
```

```{r Plot annual mean, fig.width=8, fig.asp=.618}
# For each HIS id, 
# Plot the annual mean of each metric
# Facet by metric. 
ggplot(annual_mean) + 
    geom_line(aes(x = year, y = mu, 
                  colour = name, 
                  group = HIS_new), 
              alpha = .8) + 
    facet_wrap(name~.,scales = "free") 
```

## Current status-quo--2020 crosssectional. 


## Appendix

String as object name
```{r}
value <- 1:5

for (i in 1:2) {
    x <- paste("varname",i, sep="")
    eval(call("<-", as.name(x), value))
}
varname2
```

```{r}
read_excel_allsheets <- function(filename, tibble = FALSE) {
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}

my_dat <- read_excel_allsheets(filename = 'data/raw.xlsx')

View(my_dat[[1]])
```

