---
title: "Getting data"
author: "Lian Rui"
date: "9/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      warning = F,
                      cache = T)
```

```{r Packages.}
library(tidyverse)
library(lubridate)
library(readxl)
```

```{r Helper functions. }
# Read all excel sheets. 
source("excel_all_sheets.R")
```

```{r Chinese character setup}
theme <- theme_get()
#using the Chinese fonts you have, check it with font book.  
theme$text$family <- "STFangsong"
theme_set(theme)
```

```{r create normal value table.}
normal_table <- data.frame(
  metrics = c("Albumin", "Phosphate", "CRP", 
              "TC", "TG", "LDL", "HDL", "Body_fat",
              "Appetite", "Mental_status",
              "Hypodynamia","Weight_index", 
              "Grip", "TSFT"),
  units = c("g/L", "mmol/L", "mg/L", 
            "mmol/L", "mmol/L", "mmol/L", "mmol/L", "%",
            "", "", "", "", "", ""),
  zero_value = c(0,0,0, 
                 0, 0, 0,0, 0, 0, 0,0, 0, 0, 0), 
  lower = c(35, 1.12, 1,  
            5.2, 1.8, 2.59, 1.04, 
            0, 0, 0,0, 0, 0, 0),
  upper = c(40, 1.45, 8,  
            6.2, 2.2, 3.34, 1.17, 
            0, 0, 0,0, 0, 0, 0), 
  max_value = 10000
)

write.csv(normal_table, "normal.csv")
```


```{r year name}
year <- 2012:2020
```

```{r include=FALSE}
# Read 9 excel sheets and return 9 data frames.  
my_dat <- read_excel_allsheets(filename = 'data/raw.xlsx')

# For each data frame
total <- data.frame()

for (i in 1:length(my_dat)) {
    
    # Label year for each data frame
    my_dat[[i]]$year <- year[i]
    
    # Fill each row with HIS id. 
    # A vector
    l <- vector()
    # Loop to fill HIS. 
    for (j in 1:nrow(my_dat[[i]])) {
        if(!is.na(my_dat[[i]]$`患者His号（完整10位数）`[j])){
            l[j] = my_dat[[i]]$`患者His号（完整10位数）`[j]
            }else{
                l[j] = l[j-1]
            }
    }
    
    # New HIS id and remove old HIS
    my_dat[[i]]$HIS_new<-l

    # pt info table
    # Col 2-9 as pt info. 
    # Col ncol(df) as row-filled HIS id. 
    pt_info <- my_dat[[i]][, c(2:9, ncol(my_dat[[i]]))]
    # Remove rows of all NAs. 
    pt_info <- pt_info %>%
        filter_all(any_vars(!is.na(.)))
    
    #Column rename of pt info
    colnames(pt_info) <- c("Gender", "Age", "HIS",
                           "Doctor", "ICD", "Dx",
                           "In-Patient", "Follow_up", "HIS_new")
    
    # Cols from col 10 as data
    # Data labeled with HIS id.
    # Col 4: HIS ID
    # Col 10 to end: data and date
    pt_data <- my_dat[[i]][, c(10:ncol(my_dat[[i]]))]
    # HIS_new as first column
    pt_data <- pt_data %>%
        select(HIS_new, everything())

    # Rearrange each pt_data to long format
    dat <- data.frame()
    for(k in 1:((ncol(pt_data)-1)/2)) {
        if(2*k + 1 <= ncol(pt_data)) {
            tmp <- pt_data[, c(1, (2*k):(2*k + 1), ncol(pt_data))]
            tmp$name <- colnames(tmp)[2]
            colnames(tmp)[2:3] <- c("data", "date")
            dat <- rbind(dat, tmp)
        }
    }
    # In each year
    # Join dat (long format pts data)
    # With pt_info
    dat <- dat %>%
        right_join(pt_info, by = "HIS_new")
    
    # Combine data of 9 years
    total <- rbind(total, dat)
}
```

```{r data cleaning}
# Date format
total$date <- ymd(total$date)
# Remove old HIS id. 
total <- total %>%
    select(-HIS)
# Remove NAs of redudant pt_info
total <- total %>%
    filter(!is.na(Gender) & 
               !is.na(Age) &
               !is.na(Doctor))
# Remove 'doctor', 'Follow_up' columns
# All entries in 'Follow_up' is high
total <- total %>%
    select(-Doctor, -Follow_up)

# Drop NAs
total <- total %>%
    filter(!is.na(data))
# Remove repeated entries. 
total <- distinct(total)
```

```{r Correct the age}
# Age is kept as the CURRENT 2020 age
# for Age in 2019, need to minus 1. 
# For each HIS id, get the year change from a year to 2020
total$year_change <- 2020 - total$year
# Substract Age 2020 with year change. 
total$Age <- total$Age - total$year_change
```

```{r Consolidate ICD entries, eval=FALSE, include=FALSE}
#Consolidate ICD code
#icd <- table(total$ICD)
#write.csv(icd, "icd.csv")
```


```{r Outlier removal 1}
outlier <- total %>%
    filter(HIS_new %in% "0000373621" & 
               name %in% "甘油三酯" & 
               year %in% "year2020")

total[total$HIS_new == "0000373621" & 
               total$name == "甘油三酯" & 
               total$year == 2020 & 
          total$data == 22.29, ]$data <- median(outlier$data)
```

```{r Outlier removal 2}
outlier <- total %>%
    filter((HIS_new %in% "0005316026") & 
               name %in% "血清肌酐" & 
               year %in% 2013) %>%
    arrange(desc(data))

total[total$HIS_new == "0005316026" & 
               total$name == "血清肌酐" & 
               total$year == 2013 & 
          total$data == 25938.0, ]$data <- median(outlier$data)
```

```{r Outlier removal 3}
outlier <- total %>%
    filter((HIS_new %in% "0000701411") & 
               name %in% "血清肌酐" & 
               year %in% 2013) %>%
    arrange(desc(data))

total[total$HIS_new == "0000701411" & 
               total$name == "血清肌酐" & 
               total$year == 2013 & 
          total$data == 23239.0, ]$data <- median(outlier$data)
```

```{r outlier removal 4}
outlier <- total %>%
    filter((HIS_new %in% "0005922995") & 
               name %in% "血清肌酐" & 
               year %in% 2015) %>%
    arrange(desc(data))


total[total$HIS_new == "0005922995" & 
               total$name == "血清肌酐" & 
               total$year == 2015 & 
          total$data == 1997.0, ]$data <- median(outlier$data)
```

$$
\text{eGFR}_{\text{male}} = 186 \times \text{Serum Cr}^{-1.154}\times \text{Age}^{-0.203} \\

\text{eGFR}_{\text{female}} = 186 \times \text{Serum Cr}^{-1.154}\times \text{Age}^{-0.203} \times {0.742}
$$


```{r}
# Select all creatine 
cr <- total %>%
  filter(name %in% "血清肌酐")

eGFR <- function(data = cr) {
  if(cr$Gender %in% "男") {
    # male formula
    eGFR <- 88.41 * 186 * (cr$data)^(-1.154) * (cr$Age)^(-0.203)
  }else{
    # female formula
    eGFR <- 88.41 * 186 * (cr$data)^(-1.154 )* (cr$Age)^(-0.203) * 0.742
  }
}

cr$name <- "eGFR"
cr$data <- eGFR(data = cr)
total <- rbind(total, cr)

total <- total %>%
  filter(! name %in% "估算肾小球滤过率")
```


```{r remove BP and weight}
# BP weight data only available in 2020
# Excluded from longitudinal analysis
# Included in 2020 cross-sectional analysis. 
# Longi_total as data set for longitudinal analysis. 
longi_total <- total %>%
    filter(!name %in% "收缩压" &
               !name %in% "舒张压" &
               !name %in% "体重")
```

```{r annual mean by metrics}
# For each HIS id, 
# Calculate the annual mean of each metric
annual_mean <- longi_total %>%
    group_by(HIS_new, year, name) %>%
    summarise(mu = mean(data, na.rm = TRUE))
```

```{r Plot annual mean, fig.width=8, fig.asp=.618}
# For each HIS id, 
# Plot the annual mean of each metric
# Facet by metric. 
ggplot(annual_mean) + 
    geom_line(aes(x = year, y = mu, 
                  colour = name, 
                  group = HIS_new), 
              alpha = .8) + 
    facet_wrap(name~.,scales = "free") 
```

```{r}
# Read ICD.xlsx
icd <- read_excel("icd.xlsx")
# Select two columns
icd <- icd[, c(2:3)]

# Select total data in 2020
# Only 2020 data has ICD entries
total_2020 <- total %>%
  filter(year %in% 2020)

# Join icd with total_2020
# In total_2020: use column 'ICD'; 
# In icd, use column 'RAW'. 
total_2020 <- total_2020 %>%
  left_join(icd)

# Select HIS_new and new_icd columns
# This is a unified icd diagnosis for each patient in each year
icd <- total_2020 %>%
  select(HIS_new, NewICD)

# Join ICD with total dataset
total <- total %>%
  left_join(icd, by = "HIS_new")

# Drop NAs in NewICD
total <- total %>%
  filter(! is.na(NewICD))

# Remove column 'ICD', 'Dx', 'year_change'
total <- total %>%
  select(-ICD, -Dx, -year_change)
```

```{r}
# Subset to get all eGFR
egfr <- total %>%
  filter(name %in% "eGFR")

# Select HIS_new, data and date
egfr <- egfr %>%
  select(HIS_new, data, date)

# Join egfr by HIS_new and date
# With total
total <- merge(total, egfr, by = c("HIS_new", "date"))
```


## Current status-quo--2020 crosssectional. 


## Appendix

String as object name
```{r}
value <- 1:5

for (i in 1:2) {
    x <- paste("varname",i, sep="")
    eval(call("<-", as.name(x), value))
}
varname2
```

```{r}
read_excel_allsheets <- function(filename, tibble = FALSE) {
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}

my_dat <- read_excel_allsheets(filename = 'data/raw.xlsx')

View(my_dat[[1]])
```

